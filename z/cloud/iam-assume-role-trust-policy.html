<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>The Confusing assumeRole and Trust Policy</title></head><body><article class="page serif"><header><h1 class="page-title">The Confusing assumeRole and Trust Policy</h1><p class="page-description"></p><table class="properties"><tbody><tr class="property-row property-row-created_by"><th><span class="icon property-icon"><svg role="graphics-symbol" viewBox="0 0 16 16" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.45);flex-shrink:0" class="typesCreatedBy"><path d="M8 15.126C11.8623 15.126 15.0615 11.9336 15.0615 8.06445C15.0615 4.20215 11.8623 1.00293 7.99316 1.00293C4.13086 1.00293 0.938477 4.20215 0.938477 8.06445C0.938477 11.9336 4.1377 15.126 8 15.126ZM8 10.4229C6.05176 10.4229 4.54785 11.1133 3.83008 11.9131C2.90039 10.9082 2.33301 9.55469 2.33301 8.06445C2.33301 4.91992 4.84863 2.39746 7.99316 2.39746C11.1377 2.39746 13.6738 4.91992 13.6738 8.06445C13.6738 9.55469 13.1064 10.9082 12.1699 11.9131C11.4521 11.1133 9.94824 10.4229 8 10.4229ZM8 9.30176C9.32617 9.30859 10.3516 8.18066 10.3516 6.71094C10.3516 5.33008 9.31934 4.18164 8 4.18164C6.6875 4.18164 5.6416 5.33008 5.64844 6.71094C5.65527 8.18066 6.68066 9.28809 8 9.30176Z"></path></svg></span>Created by</th><td><span class="user"><img src="The%20Confusing%20assumeRole%20and%20Trust%20Policy%201276cd51990d8095b0f1e621b700cf95/IMG_2295.jpg" class="icon user-icon"/>JiaLin Huang</span></td></tr><tr class="property-row property-row-last_edited_time"><th><span class="icon property-icon"><svg role="graphics-symbol" viewBox="0 0 16 16" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.45);flex-shrink:0" class="typesCreatedAt"><path d="M8 15.126C11.8623 15.126 15.0615 11.9336 15.0615 8.06445C15.0615 4.20215 11.8623 1.00293 7.99316 1.00293C4.13086 1.00293 0.938477 4.20215 0.938477 8.06445C0.938477 11.9336 4.1377 15.126 8 15.126ZM8 13.7383C4.85547 13.7383 2.33301 11.209 2.33301 8.06445C2.33301 4.91992 4.84863 2.39746 7.99316 2.39746C11.1377 2.39746 13.6738 4.91992 13.6738 8.06445C13.6738 11.209 11.1445 13.7383 8 13.7383ZM4.54102 8.91211H7.99316C8.30078 8.91211 8.54004 8.67285 8.54004 8.37207V3.8877C8.54004 3.58691 8.30078 3.34766 7.99316 3.34766C7.69238 3.34766 7.45312 3.58691 7.45312 3.8877V7.83203H4.54102C4.2334 7.83203 4.00098 8.06445 4.00098 8.37207C4.00098 8.67285 4.2334 8.91211 4.54102 8.91211Z"></path></svg></span>Last edited</th><td><time>@2024年10月24日 11:54</time></td></tr><tr class="property-row property-row-multi_select"><th><span class="icon property-icon"><svg role="graphics-symbol" viewBox="0 0 16 16" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.45);flex-shrink:0" class="typesMultipleSelect"><path d="M1.91602 4.83789C2.44238 4.83789 2.87305 4.40723 2.87305 3.87402C2.87305 3.34766 2.44238 2.91699 1.91602 2.91699C1.38281 2.91699 0.952148 3.34766 0.952148 3.87402C0.952148 4.40723 1.38281 4.83789 1.91602 4.83789ZM5.1084 4.52344H14.3984C14.7607 4.52344 15.0479 4.23633 15.0479 3.87402C15.0479 3.51172 14.7607 3.22461 14.3984 3.22461H5.1084C4.74609 3.22461 4.45898 3.51172 4.45898 3.87402C4.45898 4.23633 4.74609 4.52344 5.1084 4.52344ZM1.91602 9.03516C2.44238 9.03516 2.87305 8.60449 2.87305 8.07129C2.87305 7.54492 2.44238 7.11426 1.91602 7.11426C1.38281 7.11426 0.952148 7.54492 0.952148 8.07129C0.952148 8.60449 1.38281 9.03516 1.91602 9.03516ZM5.1084 8.7207H14.3984C14.7607 8.7207 15.0479 8.43359 15.0479 8.07129C15.0479 7.70898 14.7607 7.42188 14.3984 7.42188H5.1084C4.74609 7.42188 4.45898 7.70898 4.45898 8.07129C4.45898 8.43359 4.74609 8.7207 5.1084 8.7207ZM1.91602 13.2324C2.44238 13.2324 2.87305 12.8018 2.87305 12.2686C2.87305 11.7422 2.44238 11.3115 1.91602 11.3115C1.38281 11.3115 0.952148 11.7422 0.952148 12.2686C0.952148 12.8018 1.38281 13.2324 1.91602 13.2324ZM5.1084 12.918H14.3984C14.7607 12.918 15.0479 12.6309 15.0479 12.2686C15.0479 11.9062 14.7607 11.6191 14.3984 11.6191H5.1084C4.74609 11.6191 4.45898 11.9062 4.45898 12.2686C4.45898 12.6309 4.74609 12.918 5.1084 12.918Z"></path></svg></span>Tags</th><td><span class="selected-value select-value-color-purple">Post</span><span class="selected-value select-value-color-red">aws</span><span class="selected-value select-value-color-purple">iam</span><span class="selected-value select-value-color-pink">s3</span></td></tr></tbody></table></header><div class="page-body"><p class="">The IAM Role, IAM User, Trust Relationship, Trust…</p><p class="">
</p><h1 class="">TL;DR</h1><p class="">assumeRole is useful in situations where you don&#x27;t want to specify users or list a bunch of access permissions for S3. Instead, you only allow users with assumeRole permission, and those who meet the assumeRole requirements get temporary access.</p><p class="">
</p><p class="">Think of it like:</p><ul class="bulleted-list"><li style="list-style-type:disc">A Role is like a party, and Role &gt; Principal is like the guest list</li></ul><ul class="bulleted-list"><li style="list-style-type:disc">User Policy is the actual invitation</li></ul><ul class="bulleted-list"><li style="list-style-type:disc">Even if you&#x27;re on the party list</li></ul><ul class="bulleted-list"><li style="list-style-type:disc">You still need the invitation to get in</li></ul><p class="">
</p><h1 class="">Trusted Policy</h1><figure class="image"><a href="https://s3.us-east-1.amazonaws.com/jialin00.com-assets/assume-role-trust-policy.png"><img src="https://s3.us-east-1.amazonaws.com/jialin00.com-assets/assume-role-trust-policy.png"/></a></figure><h1 class="">IAM Role with Trust Policy</h1><ul class="bulleted-list"><li style="list-style-type:disc">A Role is just a collection of permission definitions</li></ul><ul class="bulleted-list"><li style="list-style-type:disc">Roles are used by other entities (like Users)</li></ul><p class="">In simple terms, it defines who (principal) I trust to assume my role</p><p class="">When you create a Role, there&#x27;s a Trust Relationship tab that won&#x27;t be empty.</p><p class="">For example, the basic <strong>AWSServiceRoleForECS:</strong></p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre class="code"><code class="language-JSON">{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Principal&quot;: {
                &quot;Service&quot;: &quot;ecs.amazonaws.com&quot;
            },
            &quot;Action&quot;: &quot;sts:AssumeRole&quot;
        }
    ]
}</code></pre><p class="">Or you can also customize it, like <strong>appleRole</strong>:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre class="code"><code class="language-JSON">{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Principal&quot;: {
                &quot;AWS&quot;: [
                    // Within AWS:
                    &quot;arn:aws:iam::ACCOUNT-ID-1:user/username1&quot;,
                    &quot;arn:aws:iam::ACCOUNT-ID-2:root&quot;,
                    &quot;arn:aws:iam::ACCOUNT-ID-3:role/some-role&quot;,
                    
                    // or use array is fine
                    [&quot;arn:aws:iam::ACCOUNT-ID-4:user/*&quot;]  // all users under spec account
                ],
                // Outside AWS: through OIDC
                &quot;Federated&quot;: [
                    &quot;cognito-identity.amazonaws.com&quot;,  // AWS Cognito
                    &quot;accounts.google.com&quot;,  // Google
                    &quot;graph.facebook.com&quot;,   // Facebook
                    &quot;www.amazon.com&quot;        // Amazon
                ],
                // for aws services
                &quot;Service&quot;: [
                    &quot;lambda.amazonaws.com&quot;,
                    &quot;ec2.amazonaws.com&quot;
                ]
            },
            &quot;Action&quot;: &quot;sts:AssumeRole&quot;
        }
    ]
}</code></pre><p class="">
</p><p class="">
</p><h1 class="">Required IAM User Permissions</h1><p class="">What roles can I assume? This is defined in the <strong>Resource</strong></p><p class=""><mark class="highlight-blue"><strong>Just being mentioned in the Role&#x27;s Principal isn&#x27;t enough - I still need to declare in my policy that &quot;I&#x27;m allowed to assume certain roles&quot;</strong></mark></p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre class="code"><code class="language-JSON">{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: &quot;sts:AssumeRole&quot;,
            &quot;Resource&quot;: &quot;arn:aws:iam::ACCOUNT-ID:role/appleRole&quot;
        }
    ]
}</code></pre><p class="">
</p><p class="">When I need to do something, like accessing S3, I first need to get a temporary pass, with controllable access duration.</p><p class="">
</p><p class="">
</p><h1 class="">S3 Bucket Policy</h1><p class="">Depending on the situation:</p><ul class="bulleted-list"><li style="list-style-type:disc">If the IAM Role itself has S3-related permissions<ul class="bulleted-list"><li style="list-style-type:circle">No need to specify in S3 Bucket Policy, Bucket Policy can be empty</li></ul></li></ul><ul class="bulleted-list"><li style="list-style-type:disc">If Bucket Policy exists, it needs to explicitly allow that role like this:<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre class="code"><code class="language-JSON">{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [{
        &quot;Effect&quot;: &quot;Allow&quot;,
        &quot;Principal&quot;: {
            &quot;AWS&quot;: &quot;arn:aws:iam::ACCOUNT-ID:role/appleRole&quot;
        },
        &quot;Action&quot;: [&quot;s3:GetObject&quot;, &quot;s3:ListBucket&quot;],
        &quot;Resource&quot;: [
            &quot;arn:aws:s3:::my-bucket&quot;,
            &quot;arn:aws:s3:::my-bucket/*&quot;
        ]
    }]
}</code></pre></li></ul><p class="">
</p><p class="">
</p><h1 class="">Benefits of this design</h1><ol type="1" class="numbered-list" start="1"><li>No need to create long-term IAM Users</li></ol><ol type="1" class="numbered-list" start="2"><li>Can control session duration:<br/><br/><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre class="code"><code class="language-Python">import boto3

# create STS client
sts_client = boto3.client(&#x27;sts&#x27;)

# give me the key
response = sts_client.assume_role(
    RoleArn=&#x27;arn:aws:iam::ACCOUNT_ID:role/S3AccessRole&#x27;,
    RoleSessionName=&#x27;S3AccessSession&#x27;
)


credentials = response[&#x27;Credentials&#x27;]

# use key to open the door
s3_client = boto3.client(
    &#x27;s3&#x27;,
    aws_access_key_id=credentials[&#x27;AccessKeyId&#x27;],
    aws_secret_access_key=credentials[&#x27;SecretAccessKey&#x27;],
    aws_session_token=credentials[&#x27;SessionToken&#x27;]
)</code></pre></li></ol><ol type="1" class="numbered-list" start="3"><li>All operations can be tracked and audited in CloudTrail</li></ol></div></article><span class="sans" style="font-size:14px;padding-top:2em"></span></body>